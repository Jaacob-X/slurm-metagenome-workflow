#!/bin/bash

#================================================================
# SLURM BATCH JOB SCRIPT - KNEADDATA SINGLE JOB (ALL SAMPLES)
#================================================================
# NOTE: SBATCH directives use default values. Adjust these directly or use
# sbatch command-line overrides (e.g., sbatch --cpus-per-task=32 script.slurm)
#SBATCH --job-name=kneaddata_single
#SBATCH --partition=normal
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=24
#SBATCH --mem=64G
#SBATCH --time=120:00:00
#SBATCH --output=logs/kneaddata_single_%j.out
#SBATCH --error=logs/kneaddata_single_%j.err

# --- Fail the script if any command fails
set -e

#================================================================
# ENVIRONMENT SETUP
#================================================================
# Activate your Conda environment that contains Kneaddata
# This step is crucial and replaces the 'module load' approach
echo "--- Activating Conda environment ---"
module load miniforge3
conda activate kneaddata
# Verify that the kneaddata command is available
command -v kneaddata

#================================================================
# SCRIPT COMMANDS
#================================================================

echo "--- Job started on $(hostname) at $(date) ---"

# --- 1. Source configuration ---
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
source "${SCRIPT_DIR}/../../config.sh"

# --- 2. DEFINE DIRECTORIES ---
# This is the output directory from your new trimgalore script
INPUT_DIR="$TRIMMED_DIR"
# This will be the final output directory for the clean, host-free reads
OUTPUT_BASE_DIR="$KNEADDATA_DIR"

# Create directories if they don't exist
mkdir -p "$OUTPUT_BASE_DIR"

echo "Input directory: $INPUT_DIR"
echo "Output directory: $OUTPUT_BASE_DIR"
echo "Reference database: $KNEADDATA_DB"

# --- 3. PROCESS EACH SAMPLE ---
# The logic here loops through the subdirectories created by the trimgalore script
processed_count=0
skipped_count=0

for SAMPLE_DIR in "$INPUT_DIR"/*; do
    if [ -d "$SAMPLE_DIR" ]; then
        SAMPLE_NAME=$(basename "$SAMPLE_DIR")

        # --- AUTO-RESUME CHECK ---
        # Define final output directory and expected output files
        OUTPUT_SAMPLE_DIR="$OUTPUT_BASE_DIR/$SAMPLE_NAME"
        # Kneaddata's output files are named based on input R1 filename:
        # Input: sample_1_val_1.fq.gz -> Output: sample_1_val_1_kneaddata_paired_1.fastq
        final_r1="${OUTPUT_SAMPLE_DIR}/${SAMPLE_NAME}_1_val_1_kneaddata_paired_1.fastq"
        final_r2="${OUTPUT_SAMPLE_DIR}/${SAMPLE_NAME}_1_val_1_kneaddata_paired_2.fastq"

        if [[ -f "$final_r1" && -f "$final_r2" && -s "$final_r1" && -s "$final_r2" ]]; then
            echo ">>> Sample $SAMPLE_NAME is already processed. Final files found. Skipping."
            echo "---------------------------------"
            ((skipped_count++))
            continue
        fi
        # --- END OF CHECK ---

        echo ">>> Processing sample: $SAMPLE_NAME"

        # Define the input files generated by your new trimgalore script (compressed)
        INPUT_R1="$SAMPLE_DIR/${SAMPLE_NAME}_1_val_1.fq.gz"
        INPUT_R2="$SAMPLE_DIR/${SAMPLE_NAME}_2_val_2.fq.gz"

        # Verify that the trimmed input files exist
        if [[ ! -f "$INPUT_R1" || ! -f "$INPUT_R2" ]]; then
            echo "ERROR: Missing trimmed input files for sample $SAMPLE_NAME. Skipping."
            echo "Looked for: $INPUT_R1 and $INPUT_R2"
            continue
        fi

        # Create output directory for this sample
        mkdir -p "$OUTPUT_SAMPLE_DIR"

        # Run Kneaddata, keeping original parameters and adding robust options
        # NOTE: The entire command is on multiple lines using backslashes '\'
        kneaddata \
            --input1 "$INPUT_R1" \
            --input2 "$INPUT_R2" \
            --reference-db "$KNEADDATA_DB" \
            --output "$OUTPUT_SAMPLE_DIR" \
            --threads $SLURM_CPUS_PER_TASK \
            --trimmomatic "$TRIMMOMATIC_PATH" \
            --trimmomatic-options "HEADCROP:15 SLIDINGWINDOW:4:15 MINLEN:50"

        # Verify output files were created
        if [[ -f "$final_r1" && -f "$final_r2" && -s "$final_r1" && -s "$final_r2" ]]; then
            echo ">>> Kneaddata processing completed for sample: $SAMPLE_NAME"
            echo "Output files:"
            echo "  R1: $final_r1"
            echo "  R2: $final_r2"
            # Show file sizes for verification
            ls -lh "$final_r1" "$final_r2"
            ((processed_count++))
        else
            echo ">>> ERROR: Kneaddata failed for sample: $SAMPLE_NAME"
            echo "Expected output files not found:"
            echo "  R1: $final_r1"
            echo "  R2: $final_r2"
            echo "Files in output directory:"
            ls -la "$OUTPUT_SAMPLE_DIR"
            exit 1
        fi

        echo "---------------------------------"
    fi
done

echo "--- All samples processed successfully at $(date) ---"
echo "--- Processed samples: $processed_count ---"
echo "--- Skipped samples: $skipped_count ---"